<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investasi Saham GIAA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .header-gradient { background: linear-gradient(135deg, #007bff, #0056b3); color: white; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06); }
        .price-up { color: #16a34a; transition: color 0.3s; }
        .price-down { color: #dc2626; transition: color 0.3s; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Chat Styles */
        #messages-container::-webkit-scrollbar { width: 6px; }
        #messages-container::-webkit-scrollbar-thumb { background-color: #94a3b8; border-radius: 3px; }
        #messages-container::-webkit-scrollbar-track { background: #f1f5f9; }
        .my-message { border-radius: 12px 12px 0 12px; }
        .other-message { border-radius: 12px 12px 12px 0; }
        
        /* Pop Up & Animations */
        .fade-in-up { animation: fadeInUp 0.3s ease-out forwards; }
        .fade-out-down { animation: fadeOutDown 0.3s ease-in forwards; }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translate(-50%, -40%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }
        @keyframes fadeOutDown {
            from { opacity: 1; transform: translate(-50%, -50%); }
            to { opacity: 0; transform: translate(-50%, -40%); }
        }

        /* Input Styles - High Contrast */
        .input-user {
            @apply w-full p-3 border border-gray-300 rounded-lg bg-white text-gray-900 font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition;
        }
    </style>
</head>
<body class="p-4 sm:p-6 relative min-h-screen">
    <!-- Loading -->
    <div id="transitionOverlay" class="fixed inset-0 bg-white/90 hidden flex items-center justify-center z-[600] opacity-0 transition-opacity duration-300">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-4"></div>
            <p class="text-lg font-semibold text-blue-700" id="loadingText">Menghubungkan ke Server...</p>
        </div>
    </div>
    
    <!-- Temporary Transaction Popup -->
    <div id="tempTransactionPopup" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/80 text-white px-6 py-4 rounded-xl shadow-2xl z-[2000] hidden flex-col items-center justify-center text-center min-w-[200px]">
        <div class="w-10 h-10 mb-2 rounded-full bg-green-500 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
        </div>
        <p class="font-semibold text-sm">Transaksi sedang diproses</p>
    </div>

    <div id="app" class="max-w-4xl mx-auto pb-24"> 
        <header class="header-gradient p-5 rounded-xl mb-6 flex justify-between items-center">
            <div><h1 class="text-3xl font-bold">Garuda Invest Pro (G-Invest)</h1><p class="text-sm font-light opacity-80">Platform Trading & Investasi Saham</p></div>
            <button id="auth-status-button" class="py-2 px-4 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg transition duration-200"><span id="auth-status-text">Log In</span></button>
        </header>

        <!-- Login Modal -->
        <div id="loginModal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center p-4 z-[1000]">
            <div id="loginModalContent" class="bg-white p-8 rounded-xl max-w-sm w-full card-shadow text-center" onclick="event.stopPropagation()">
                <h3 class="text-2xl font-bold mb-6 text-blue-700">Masuk ke G-Invest</h3>
                <p class="text-sm text-gray-500 mb-4">Gunakan Nomor HP dan Password Anda.</p>
                <form id="loginForm">
                    <div class="mb-4"><input type="text" id="loginPhone" placeholder="Nomor HP (e.g. 0812...)" class="input-user" required></div>
                    <div class="mb-6"><input type="password" id="loginPassword" placeholder="Password" class="input-user" required></div>
                    <button type="submit" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition duration-200 shadow-lg">Login</button>
                </form>
            </div>
        </div>

        <!-- Registration Modal -->
        <div id="registerModal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center p-4 z-[1000] hidden">
            <div class="bg-white p-8 rounded-xl max-w-md w-full card-shadow text-center" onclick="event.stopPropagation()">
                <h3 class="text-2xl font-bold mb-2 text-green-600">Pengguna Baru Terdeteksi</h3>
                <p class="text-sm text-gray-500 mb-6">Nomor HP ini belum terdaftar. Dapatkan <span class="font-bold text-blue-600">1000 Lot Gratis</span> (Akun Trial).</p>
                <form id="registerForm">
                    <div class="mb-4 text-left"><label class="block text-xs font-bold text-gray-600 mb-1">Nama Lengkap</label><input type="text" id="regName" class="input-user" required></div>
                    <div class="mb-4 text-left"><label class="block text-xs font-bold text-gray-600 mb-1">Nama Bank</label><select id="regBank" class="input-user" required><option value="BCA">BCA</option><option value="BRI">BRI</option><option value="BNI">BNI</option><option value="MANDIRI">MANDIRI</option><option value="LAINNYA">LAINNYA</option></select></div>
                    <div class="mb-6 text-left"><label class="block text-xs font-bold text-gray-600 mb-1">Nomor Rekening</label><input type="number" id="regAccountNum" class="input-user" required></div>
                    <button type="submit" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition duration-200 shadow-lg">Buat Akun Trial</button>
                    <button type="button" id="cancelRegisterBtn" class="mt-3 w-full py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold rounded-lg transition">Batal</button>
                </form>
            </div>
        </div>
        
        <!-- Main Content -->
        <div id="main-content" class="hidden">
            <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Market & Trading -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white p-6 rounded-xl card-shadow relative">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center">
                                <img src="https://placehold.co/40x40/007bff/ffffff?text=GI" alt="Logo" class="w-10 h-10 rounded-full mr-3 border-2 border-blue-100">
                                <div><h2 class="text-xl font-bold text-gray-800">GIAA (Live Market)</h2><p class="text-sm text-gray-500">Bursa Efek Indonesia</p></div>
                            </div>
                            <div class="text-right"><p class="text-4xl font-extrabold" id="current-price">115</p><p class="text-sm font-semibold text-gray-500" id="price-status">Market Open</p></div>
                        </div>
                        <div class="h-64 w-full mb-4"><canvas id="stockChart"></canvas></div>
                        
                        <!-- Trading Interface -->
                        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-700">Trading Cepat (20 Detik)</h3><div id="tradeTimerDisplay" class="text-xl font-mono font-bold text-gray-400">00:20</div></div>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">MODAL (BID)</label><input type="number" id="bidAmount" value="100000" min="10000" class="input-user"></div>
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">POTENSI PROFIT (80%)</label><div class="w-full p-3 bg-green-100 border border-green-200 rounded-lg font-bold text-green-700" id="potentialProfit">Rp 80.000</div></div>
                            </div>
                            <div class="flex space-x-3">
                                <button id="btnCall" type="button" class="flex-1 py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg shadow-lg flex flex-col items-center justify-center transition active:scale-95"><span>NAIK</span></button>
                                <button id="btnPut" type="button" class="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white font-bold rounded-lg shadow-lg flex flex-col items-center justify-center transition active:scale-95"><span>TURUN</span></button>
                            </div>
                            <div id="activeTradeInfo" class="mt-3 text-center text-sm font-semibold hidden"><p>Posisi: <span id="tradePosition" class="uppercase font-bold"></span> @ <span id="tradeEntryPrice"></span></p><p class="text-xs text-gray-500">Menunggu hasil...</p></div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-xl card-shadow flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
                        <div><h3 class="font-bold text-gray-800">Investasi Saham Reguler</h3><p class="text-xs text-gray-500">Beli dan simpan saham untuk jangka panjang.</p></div>
                        <div class="flex space-x-2"><button id="openCompanyInfoBtn" class="py-2 px-4 bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-semibold rounded border border-indigo-200">Info Perusahaan</button><button id="sellBtn" class="py-2 px-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold rounded">Jual Stok</button><button id="buyBtn" class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded">Beli Stok</button></div>
                    </div>
                </div>
                <!-- Right: Profil -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-indigo-50 p-6 rounded-xl card-shadow border-2 border-indigo-200">
                        <h3 class="text-xl font-bold mb-4 text-indigo-800 flex justify-between items-center">
                            Profil Pengguna
                            <span id="statusBadge" class="text-xs px-2 py-1 bg-gray-200 rounded-full text-gray-600 ml-2">Loading...</span>
                        </h3>
                        <div class="space-y-3">
                            <div class="bg-white p-3 rounded-lg border-l-4 border-indigo-500"><p class="text-xs text-gray-500">Nama Pengguna</p><span class="text-lg font-bold text-indigo-700" id="user-name">...</span></div>
                            <div class="bg-white p-3 rounded-lg border-l-4 border-indigo-500"><p class="text-xs text-gray-500">Nomor Rekening</p><span class="text-sm font-medium text-gray-600 truncate" id="user-id">...</span></div>
                            <div class="bg-white p-3 rounded-lg flex justify-between items-center border-l-4 border-yellow-500"><span class="font-medium text-gray-700">Saldo Kas RDN</span><span class="text-xl font-bold text-yellow-600" id="rdn-cash-balance">Rp 0</span></div>
                            <div class="bg-white p-3 rounded-lg flex justify-between items-center border-l-4 border-blue-500"><span class="font-medium text-gray-700">Aset Saham (Lot)</span><span class="text-xl font-bold text-blue-600" id="profile-portfolio-value">Rp 0</span></div>
                        </div>
                        <!-- Action Buttons Grid -->
                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <button id="topUpBtn" class="py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition shadow-md flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                                Isi Saldo
                            </button>
                            <button id="withdrawalBtn" class="py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition shadow-md flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                Tarik Dana
                            </button>
                        </div>
                    </div>
                    <div class="bg-blue-50 p-6 rounded-xl card-shadow border-2 border-blue-200"><h3 class="font-bold text-blue-800 mb-2">Aset Saham Dimiliki</h3><p class="text-3xl font-bold text-blue-700" id="lot-owned">0 Lot</p><p class="text-sm text-gray-500">Nilai estimasi harga pasar saat ini.</p></div>
                </div>
            </main>
        </div>

        <!-- Modals and Overlay Components -->
        
        <!-- Top Up Input Modal -->
        <div id="topUpInputModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-[1000]">
            <div class="bg-white p-6 rounded-xl max-w-md w-full card-shadow">
                <h3 class="text-2xl font-bold mb-4 text-green-700 border-b pb-2">Isi Saldo RDN</h3>
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">Nominal Top Up (Rp)</label>
                    <input type="number" id="topUpAmountInput" min="10000" class="input-user" placeholder="Minimal Rp 10.000">
                </div>
                <div class="text-right">
                    <button type="button" id="cancelTopUpInputBtn" class="py-2 px-4 bg-gray-300 hover:bg-gray-400 rounded-lg mr-2 font-bold">Batal</button>
                    <button type="button" id="proceedTopUpBtn" class="py-2 px-4 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold">Lanjut Bayar</button>
                </div>
            </div>
        </div>

        <!-- Order Modal -->
        <div id="orderModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-[1000]">
            <div class="bg-white p-6 rounded-xl max-w-lg w-full card-shadow"><h3 class="text-2xl font-bold mb-4 border-b pb-2" id="modalTitle">Order Saham</h3><form id="orderForm"><div class="mb-4"><label class="block text-gray-700 font-semibold mb-2">Harga</label><input type="number" id="price" class="input-user bg-gray-100" readonly></div><div class="mb-6"><label class="block text-gray-700 font-semibold mb-2">Jumlah Lot</label><input type="number" id="lots" min="1" value="1" class="input-user" required><p id="minLotWarning" class="text-xs text-red-500 mt-2 hidden">Minimal 1 lot.</p><p id="buyMethodText" class="text-xs text-blue-600 mt-1 hidden">Pembelian menggunakan Saldo RDN.</p></div><div class="text-right"><button type="button" id="cancelOrderBtn" class="py-2 px-4 bg-gray-300 hover:bg-gray-400 rounded-lg mr-2 font-bold">Batal</button><button type="submit" id="submitButton" class="py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Konfirmasi</button></div></form></div>
        </div>
        
        <!-- Payment Modal -->
        <div id="paymentModal" class="fixed inset-0 bg-gray-900 bg-opacity-90 hidden flex items-center justify-center p-4 z-[1050]">
            <div class="bg-white p-6 rounded-xl max-w-md w-full text-center" onclick="event.stopPropagation()">
                <h3 class="text-2xl font-bold mb-4 text-green-700 border-b pb-2">Transfer Top Up</h3>
                <div class="bg-red-500 text-white font-extrabold text-4xl p-3 rounded-lg mb-4 shadow-inner"><span id="paymentTimer">01:00:00</span></div><div class="bg-gray-50 p-4 rounded-lg border border-gray-200 text-left mb-4"><p class="text-lg font-semibold text-gray-700 mb-2">Total Transfer:</p><p class="text-4xl font-extrabold text-blue-600" id="paymentAmount">Rp 0</p></div><div class="bg-yellow-50 p-4 rounded-lg border border-yellow-300 text-left mb-6 space-y-2"><div class="flex justify-between"><span>Bank:</span><span class="font-bold">BRI</span></div><div class="flex justify-between"><span>No. Rek:</span><span class="font-bold text-red-600">459801043667539</span></div><div class="flex justify-between"><span>Penerima:</span><span class="font-bold">GATOT SATRIAWAN</span></div></div>
                <button type="button" id="paymentConfirmBtn" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-lg cursor-pointer">Sudah Transfer</button>
                <button type="button" id="paymentCancelBtn" class="w-full py-3 mt-3 bg-gray-200 text-gray-800 font-bold rounded-lg hover:bg-gray-300 shadow cursor-pointer">Batalkan & Kembali</button>
            </div>
        </div>

        <!-- Withdrawal Modal -->
        <div id="withdrawalModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-[1000]"><div class="bg-white p-6 rounded-xl max-w-lg w-full"><h3 class="text-2xl font-bold mb-4 text-indigo-700">Tarik Dana</h3><form id="withdrawalForm"><div class="bg-yellow-50 p-3 rounded-lg mb-4 border border-yellow-200"><p class="text-sm font-semibold">Saldo RDN Tersedia:</p><p class="text-2xl font-bold text-yellow-600" id="modal-rdn-balance">Rp 0</p></div><div class="mb-6"><input type="number" id="withdrawalAmount" min="1000" class="input-user" value="100000" required></div><div class="text-right"><button type="button" id="cancelWithdrawalBtn" class="py-2 px-4 bg-gray-300 rounded-lg mr-2 font-bold">Batal</button><button type="submit" class="py-2 px-4 bg-indigo-600 text-white rounded-lg">Konfirmasi</button></div></form></div></div>
        
        <!-- Result Modal -->
        <div id="resultModal" class="fixed inset-0 bg-gray-900 bg-opacity-90 hidden flex items-center justify-center p-4 z-[1050]"><div class="bg-white p-8 rounded-xl max-w-sm w-full text-center"><div id="resultIcon" class="mx-auto mb-4 w-20 h-20 flex items-center justify-center rounded-full text-4xl"></div><h3 class="text-2xl font-bold mb-2" id="resultTitle">Hasil</h3><p class="text-gray-600 mb-6" id="resultMessage">Detail hasil trading.</p><button onclick="document.getElementById('resultModal').classList.add('hidden')" class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg">Tutup</button></div></div>
        
        <!-- URGENT ALERT MODAL -->
        <div id="urgentAlertModal" class="fixed inset-0 bg-black/95 flex items-center justify-center z-[2000] hidden">
            <div class="bg-red-600 p-1 rounded-2xl shadow-2xl max-w-md w-full animate-bounce-in transform scale-105">
                <div class="bg-white p-8 rounded-xl text-center">
                    <div class="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                    </div>
                    <h3 id="urgentTitle" class="text-2xl font-bold mb-3 text-gray-900">PEMBERITAHUAN PENTING</h3>
                    <p id="urgentBody" class="text-gray-600 mb-6 text-lg leading-relaxed">Mohon perhatikan pesan ini.</p>
                    <button id="urgentConfirmBtn" class="w-full py-4 bg-red-600 hover:bg-red-700 text-white font-bold text-lg rounded-xl shadow-lg transition transform active:scale-95">OK, SAYA MENGERTI</button>
                </div>
            </div>
        </div>

        <!-- Company Info Page -->
        <div id="company-info-page" class="hidden max-w-4xl mx-auto animate-fade-in"><div class="bg-white p-5 rounded-xl mb-6 flex justify-between items-center card-shadow border-l-4 border-blue-600"><div><h2 class="text-2xl font-bold text-gray-800">Profil Perusahaan</h2><p class="text-sm text-gray-500">PT Garuda Indonesia (Persero) Tbk.</p></div><button id="backToDashboardBtn" class="py-2 px-4 bg-gray-100 text-blue-600 font-bold rounded-lg hover:bg-gray-200 transition flex items-center">Kembali ke Dashboard</button></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-white p-6 rounded-xl card-shadow"><h3 class="text-lg font-bold mb-4 border-b pb-2">Data Fundamental</h3><div class="space-y-4"><div class="flex justify-between items-center border-b pb-2"><span class="text-gray-500">Kode Saham</span><span class="font-bold text-blue-600">GIAA</span></div><div class="flex justify-between items-center border-b border-gray-50 pb-2"><span class="text-gray-500">Sektor</span><span class="font-medium text-right text-gray-800">Transportasi & Logistik (Penerbangan)</span></div><div class="flex justify-between items-center border-b border-gray-50 pb-2"><span class="text-gray-500">Kapitalisasi Pasar</span><span class="font-medium text-gray-800">Rp 10.52 Triliun</span></div><div class="flex justify-between items-center"><span class="text-gray-500">P/E Ratio</span><span class="font-medium text-red-500">-5.5x</span></div></div></div><div class="bg-white p-6 rounded-xl card-shadow"><h3 class="text-lg font-bold mb-4 border-b pb-2 text-gray-800">Kontak Hubungan Investor</h3><div class="space-y-4"><div class="flex justify-between items-center border-b border-gray-50 pb-2"><span class="text-gray-500">Jabatan</span><span class="font-medium text-gray-800">VP Financial Accounting</span></div><div class="flex justify-between items-center border-b border-gray-50 pb-2"><span class="text-gray-500">Nama Kontak</span><span class="font-medium text-gray-800">Gatot Satriawan</span></div><div class="flex flex-col"><span class="text-gray-500 mb-1">Email Resmi</span><span class="font-medium text-blue-600 break-all">ccfoundation.volunteer@gmail.com</span></div></div></div></div></div>
        <div id="notificationBox" class="fixed bottom-4 right-4 text-white p-4 rounded-lg shadow-xl hidden opacity-0 transition-opacity duration-300 z-[500]"></div>
        <div id="chat-widget-container" class="fixed bottom-24 right-6 z-[9999]"><button id="chat-toggle-btn" class="w-14 h-14 bg-sky-600 text-white rounded-full shadow-2xl flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg></button></div>
        <div id="app-container" class="fixed bottom-24 right-6 z-[9999] hidden w-full max-w-[360px] bg-white shadow-2xl rounded-2xl overflow-hidden mb-4 border border-gray-200">
            <header class="bg-gradient-to-r from-sky-600 to-blue-600 text-white p-4 flex justify-between items-center shadow-lg"><div><h1 class="text-sm font-bold">CS Ginvest Live</h1><p class="text-[10px] opacity-80" id="chat-user-display">Connecting...</p></div><button onclick="document.getElementById('app-container').classList.add('hidden')" class="text-white hover:text-gray-200">&times;</button></header>
            <div id="chat-screen" class="flex flex-col h-[350px]"><div id="messages-container" class="flex-grow px-3 py-4 overflow-y-auto space-y-3 bg-gray-50"><div class="text-center text-xs text-gray-400 mt-4">Mulai percakapan dengan CS...</div></div><div class="p-3 border-t border-gray-200 bg-white"><div class="flex space-x-2"><input type="text" id="message-input" placeholder="Tulis pesan..." class="flex-grow px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500" maxlength="200"><button id="send-button" class="flex-shrink-0 bg-sky-500 hover:bg-sky-600 text-white text-sm font-semibold px-4 py-2 rounded-lg shadow transition">Kirim</button></div></div></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel, getDocs, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-ginvest-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "AIzaSyA_FynN_E6zxOEHo3k2t-olypo2Tu_D-zQ", authDomain: "webchatapp90.firebaseapp.com", projectId: "webchatapp90" };
        const app = initializeApp(firebaseConfig, "GInvestUser");
        const db = getFirestore(app);
        const auth = getAuth(app);

        const USERS_COLLECTION = `artifacts/${appId}/public/data/ginvest_users`;
        const CONFIG_DOC_PATH = `artifacts/${appId}/public/data/ginvest_market/config`;
        const MARKET_DOC_PATH = `artifacts/${appId}/public/data/ginvest_market/giaa`;
        const CHAT_COLLECTION_PATH = `artifacts/${appId}/public/data/ginvest_chats`;
        const ADMIN_NOTIFS_COLLECTION = `artifacts/${appId}/public/data/ginvest_admin_notifs`; 
        const ADMIN_EMAIL = 'admin9090@gmail.com';

        let currentUserId = null; 
        let currentUserData = { name: "Pengunjung", bank: "-", accountNumber: "-", lotOwned: 0, rdnBalance: 0, hasToppedUp: false, status: 'TRIAL', pendingTopUp: 0, pendingWithdrawal: 0 };
        let tempPhoneForReg = "", tempPassForReg = "";
        let currentPrice = 115, chartInstance, marketMode = 'RANDOM', marketInterval;
        let pendingTopUpAmount = 0;
        let tradingState = { isTrading: false, timer: 20, interval: null, entryPrice: 0, direction: '', bidAmount: 0, targetOutcome: 'RANDOM' };
        const CHART_LENGTH = 30;

        function formatRupiah(n) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n); }
        function formatNumber(n) { return new Intl.NumberFormat('id-ID').format(n); }
        function safeAddEventListener(id, event, handler) { const el = document.getElementById(id); if (el) el.addEventListener(event, handler); }

        function showTransactionPopup(msg) {
            const popup = document.getElementById('tempTransactionPopup');
            popup.querySelector('p').textContent = msg;
            popup.classList.remove('hidden'); popup.classList.add('flex', 'fade-in-up');
            setTimeout(() => { popup.classList.remove('fade-in-up'); popup.classList.add('fade-out-down'); setTimeout(() => { popup.classList.add('hidden'); popup.classList.remove('flex', 'fade-out-down'); }, 300); }, 2000);
        }

        function showNotification(msg, success = true) {
            const box = document.getElementById('notificationBox');
            box.textContent = msg;
            box.className = `fixed bottom-4 right-4 text-white p-4 rounded-lg shadow-xl z-[500] transition-opacity duration-300 ${success ? 'bg-green-500' : 'bg-red-500'}`;
            box.classList.remove('hidden', 'opacity-0');
            setTimeout(() => box.classList.add('opacity-0'), 4000);
            setTimeout(() => box.classList.add('hidden'), 4300);
        }

        async function initAuth() { if (!auth.currentUser) { if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken); else await signInAnonymously(auth); } }
        async function seedDefaultUser() {
            const userRef = doc(db, USERS_COLLECTION, "081226418380");
            try { const snap = await getDoc(userRef); if (!snap.exists()) await setDoc(userRef, { password: "qwerty123", name: "Bagus Ramadhani", bank: "BRI", accountNumber: "459801043667539", lotOwned: 1000, rdnBalance: 81000000, isTransactionPending: false, hasMadeFirstPurchase: false, isWithdrawalPending: false, hasToppedUp: true, status: 'PREMIUM', pendingTopUp: 0, pendingWithdrawal: 0 }); } catch(e) {}
        }

        function listenToUserData() {
            if(!currentUserId) return;
            let lastNotifTime = 0;
            onSnapshot(doc(db, USERS_COLLECTION, currentUserId), (docSnap) => {
                if(docSnap.exists()) {
                    const data = docSnap.data();
                    currentUserData = data; updateUI();
                    if (data.systemNotification && data.systemNotification.timestamp) {
                        const serverTime = data.systemNotification.timestamp.toMillis ? data.systemNotification.timestamp.toMillis() : 0;
                        const now = Date.now();
                        if (serverTime > now - 15000 && serverTime !== lastNotifTime) {
                            lastNotifTime = serverTime;
                            if (data.systemNotification.type === 'CUSTOM_URGENT') {
                                document.getElementById('urgentTitle').textContent = data.systemNotification.title || "PEMBERITAHUAN";
                                document.getElementById('urgentBody').textContent = data.systemNotification.msg;
                                document.getElementById('urgentAlertModal').classList.remove('hidden');
                            } else if (data.systemNotification.type === 'TOPUP') {
                                if (currentUserData.pendingTopUp > 0) {
                                    const newBalance = (currentUserData.rdnBalance || 0) + currentUserData.pendingTopUp;
                                    updateDoc(doc(db, USERS_COLLECTION, currentUserId), { rdnBalance: newBalance, pendingTopUp: 0 });
                                    showNotification("Top Up berhasil masuk!", true);
                                }
                            } else if (data.systemNotification.type === 'WITHDRAW') {
                                if (currentUserData.pendingWithdrawal > 0) {
                                    updateDoc(doc(db, USERS_COLLECTION, currentUserId), { rdnBalance: (currentUserData.rdnBalance || 0) - currentUserData.pendingWithdrawal, pendingWithdrawal: 0, isWithdrawalPending: false });
                                    showNotification("Penarikan dana berhasil.", true);
                                }
                            } else showNotification(data.systemNotification.msg, true);
                        }
                    }
                }
            });
        }
        
        safeAddEventListener('urgentConfirmBtn', 'click', () => document.getElementById('urgentAlertModal').classList.add('hidden'));

        function listenToMarketLogic() {
            onSnapshot(doc(db, "artifacts", appId, "public", "data", "ginvest_market", "giaa"), (snap) => { if (snap.exists() && snap.data().price) updatePrice(snap.data().price); });
            onSnapshot(doc(db, "artifacts", appId, "public", "data", "ginvest_market", "config"), (snap) => { if (snap.exists()) marketMode = snap.data().trendMode || 'RANDOM'; });
        }

        function startMarketLoop() {
            if (marketInterval) clearInterval(marketInterval);
            marketInterval = setInterval(() => {
                let delta = 0; const rand = Math.random(); const magnitude = Math.floor(Math.random() * 2) + 1; 
                if (tradingState.isTrading && tradingState.targetOutcome !== 'RANDOM') {
                    if (tradingState.targetOutcome === 'WIN') delta = (tradingState.direction === 'UP') ? magnitude : -magnitude; 
                    else if (tradingState.targetOutcome === 'LOSS') delta = (tradingState.direction === 'UP') ? -magnitude : magnitude;
                } else {
                    if (currentPrice <= 110) delta = magnitude; else if (currentPrice >= 130) delta = -magnitude; else delta = rand > 0.5 ? magnitude : -magnitude;
                }
                updatePrice(currentPrice + delta);
            }, 2000); 
        }

        function updatePrice(newPrice) {
            const oldPrice = currentPrice; currentPrice = newPrice; if(currentPrice < 50) currentPrice = 50; 
            const el = document.getElementById('current-price');
            el.textContent = formatNumber(currentPrice);
            el.className = currentPrice > oldPrice ? "text-4xl font-extrabold price-up" : "text-4xl font-extrabold price-down";
            if(chartInstance) { chartInstance.data.datasets[0].data.push(currentPrice); chartInstance.data.datasets[0].data.shift(); chartInstance.update(); }
            updateUI(); 
        }

        // DEFINED BEFORE USAGE
        function initChart() {
            const ctx = document.getElementById('stockChart').getContext('2d');
            chartInstance = new Chart(ctx, { type: 'line', data: { labels: Array(CHART_LENGTH).fill(''), datasets: [{ label: 'GIAA', data: Array(CHART_LENGTH).fill(115), borderColor: '#007bff', backgroundColor: 'rgba(0,123,255,0.1)', borderWidth: 2, pointRadius: 0, fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { y: { min: 100, max: 140 }, x: { display: false } }, plugins: { legend: { display: false } } } });
        }

        function updateUI() {
            document.getElementById('user-name').textContent = currentUserData.name;
            document.getElementById('user-id').textContent = `${currentUserData.bank} - ${currentUserData.accountNumber}`;
            document.getElementById('lot-owned').textContent = `${formatNumber(currentUserData.lotOwned || 0)} Lot`;
            const statusBadge = document.getElementById('statusBadge');
            if (currentUserData.status === 'PREMIUM') { statusBadge.textContent = 'PREMIUM'; statusBadge.className = 'text-xs px-2 py-1 bg-yellow-500 text-white rounded-full ml-2 font-bold shadow'; } 
            else { statusBadge.textContent = 'TRIAL'; statusBadge.className = 'text-xs px-2 py-1 bg-gray-300 text-gray-700 rounded-full ml-2 font-bold'; }
            const portfolioVal = (currentUserData.lotOwned || 0) * 100 * currentPrice;
            document.getElementById('profile-portfolio-value').textContent = formatRupiah(portfolioVal);
            const rdnElements = [document.getElementById('rdn-cash-balance'), document.getElementById('modal-rdn-balance')];
            rdnElements.forEach(el => el.textContent = formatRupiah(currentUserData.rdnBalance || 0));
        }

        safeAddEventListener('loginForm', 'submit', async (e) => {
            e.preventDefault();
            const phone = document.getElementById('loginPhone').value.trim();
            const pass = document.getElementById('loginPassword').value.trim();
            if(!phone || !pass) return;
            document.getElementById('loadingText').textContent = "Memverifikasi...";
            document.getElementById('transitionOverlay').classList.remove('hidden', 'opacity-0');
            document.getElementById('transitionOverlay').classList.add('opacity-100');
            try {
                await initAuth();
                const userRef = doc(db, USERS_COLLECTION, phone);
                let snap = await getDoc(userRef);
                if (!snap.exists() && phone === "081226418380") { await seedDefaultUser(); snap = await getDoc(userRef); }

                if(snap.exists()) {
                    if(snap.data().password === pass) { currentUserId = phone; currentUserData = snap.data(); finishLogin(); } else { alert("Password Salah"); hideLoading(); }
                } else {
                    tempPhoneForReg = phone; tempPassForReg = pass;
                    document.getElementById('loginModal').classList.add('hidden');
                    document.getElementById('registerModal').classList.remove('hidden');
                    hideLoading();
                }
            } catch(e) { alert("Error Login: " + e.message); hideLoading(); }
        });

        safeAddEventListener('registerForm', 'submit', async (e) => {
            e.preventDefault();
            const newUser = { password: tempPassForReg, name: document.getElementById('regName').value, bank: document.getElementById('regBank').value, accountNumber: document.getElementById('regAccountNum').value, lotOwned: 1000, rdnBalance: 0, isTransactionPending: false, hasMadeFirstPurchase: false, isWithdrawalPending: false, hasToppedUp: false, status: 'TRIAL', pendingTopUp: 0, pendingWithdrawal: 0 };
            await setDoc(doc(db, USERS_COLLECTION, tempPhoneForReg), newUser);
            currentUserId = tempPhoneForReg; currentUserData = newUser;
            document.getElementById('registerModal').classList.add('hidden');
            finishLogin(); showNotification("Selamat! Akun Trial aktif dengan bonus 1000 Lot.", true);
        });
        
        safeAddEventListener('cancelRegisterBtn', 'click', () => {
            document.getElementById('registerModal').classList.add('hidden');
            document.getElementById('loginModal').classList.remove('hidden');
        });

        function finishLogin() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('auth-status-text').textContent = "Log Out";
            document.getElementById('auth-status-button').className = "py-2 px-4 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg transition duration-200";
            initChart(); listenToMarketLogic(); startMarketLoop(); listenToUserData(); hideLoading();
        }

        safeAddEventListener('auth-status-button', 'click', () => { if(currentUserId) window.location.reload(); });
        function hideLoading() { const overlay = document.getElementById('transitionOverlay'); overlay.classList.remove('opacity-100'); setTimeout(() => overlay.classList.add('hidden'), 300); }

        async function updateUserData() { if(currentUserId) await updateDoc(doc(db, USERS_COLLECTION, currentUserId), { rdnBalance: currentUserData.rdnBalance, lotOwned: currentUserData.lotOwned, isTransactionPending: currentUserData.isTransactionPending, isWithdrawalPending: currentUserData.isWithdrawalPending, hasMadeFirstPurchase: currentUserData.hasMadeFirstPurchase, hasToppedUp: currentUserData.hasToppedUp, pendingTopUp: currentUserData.pendingTopUp || 0, pendingWithdrawal: currentUserData.pendingWithdrawal || 0 }); }

        safeAddEventListener('topUpBtn', 'click', () => document.getElementById('topUpInputModal').classList.remove('hidden'));
        safeAddEventListener('cancelTopUpInputBtn', 'click', () => document.getElementById('topUpInputModal').classList.add('hidden'));
        safeAddEventListener('proceedTopUpBtn', 'click', () => {
             const amount = parseInt(document.getElementById('topUpAmountInput').value);
             if (!amount || amount < 10000) return showNotification("Minimal Top Up Rp 10.000", false);
             pendingTopUpAmount = amount;
             document.getElementById('topUpInputModal').classList.add('hidden');
             document.getElementById('paymentAmount').textContent = formatRupiah(amount);
             document.getElementById('paymentModal').classList.remove('hidden');
        });

        safeAddEventListener('withdrawalForm', 'submit', (e) => {
            e.preventDefault();
            if (currentUserData.status !== 'PREMIUM') { document.getElementById('withdrawalModal').classList.add('hidden'); return alert("Akun Trial tidak dapat menarik dana. Silakan lakukan Top Up untuk upgrade ke Premium."); }
            const amt = parseInt(document.getElementById('withdrawalAmount').value);
            if(amt > currentUserData.rdnBalance) return showNotification("Saldo RDN tidak mencukupi.", false);
            currentUserData.isWithdrawalPending = true; currentUserData.pendingWithdrawal = amt; 
            updateUserData();
            addDoc(collection(db, ADMIN_NOTIFS_COLLECTION), { type: 'WITHDRAW', user: currentUserId, name: currentUserData.name, amount: amt, timestamp: serverTimestamp() });
            document.getElementById('withdrawalModal').classList.add('hidden'); showTransactionPopup("Permintaan penarikan dana sedang diproses.");
        });

        safeAddEventListener('withdrawalBtn', 'click', () => document.getElementById('withdrawalModal').classList.remove('hidden'));
        safeAddEventListener('cancelWithdrawalBtn', 'click', () => document.getElementById('withdrawalModal').classList.add('hidden'));
        
        const buyBtn = document.getElementById('buyBtn');
        const sellBtn = document.getElementById('sellBtn');
        if(buyBtn) buyBtn.addEventListener('click', () => { document.getElementById('modalTitle').textContent = 'Beli Saham'; document.getElementById('submitButton').textContent = 'Konfirmasi Beli'; document.getElementById('price').value = currentPrice; document.getElementById('lots').value = 1; document.getElementById('lots').min = 1; document.getElementById('minLotWarning').classList.add('hidden'); document.getElementById('buyMethodText').classList.remove('hidden'); document.getElementById('orderModal').classList.remove('hidden'); });
        if(sellBtn) sellBtn.addEventListener('click', () => { if(currentUserData.lotOwned <= 0) return showNotification("Anda belum memiliki aset saham untuk dijual.", false); document.getElementById('modalTitle').textContent = 'Jual Saham'; document.getElementById('submitButton').textContent = 'Konfirmasi Jual'; document.getElementById('price').value = currentPrice; document.getElementById('lots').value = 1; document.getElementById('minLotWarning').classList.add('hidden'); document.getElementById('buyMethodText').classList.add('hidden'); document.getElementById('orderModal').classList.remove('hidden'); });
        safeAddEventListener('cancelOrderBtn', 'click', () => document.getElementById('orderModal').classList.add('hidden'));

        safeAddEventListener('orderForm', 'submit', (e) => {
            e.preventDefault();
            const action = document.getElementById('submitButton').textContent; const lots = parseInt(document.getElementById('lots').value); const cost = lots * 100 * currentPrice;
            if (action.includes('Jual')) {
                if (lots > currentUserData.lotOwned) return showNotification("Jumlah lot yang ingin dijual melebihi kepemilikan Anda.", false);
                currentUserData.lotOwned -= lots; currentUserData.rdnBalance += cost; updateUserData(); document.getElementById('orderModal').classList.add('hidden'); showNotification("Berhasil menjual " + formatNumber(lots) + " Lot GIAA. Dana " + formatRupiah(cost) + " masuk ke RDN.", true);
            } else {
                if (lots < 1) return showNotification("Minimal pembelian adalah 1 Lot.", false);
                if (currentUserData.rdnBalance < cost) { document.getElementById('orderModal').classList.add('hidden'); showNotification("Saldo RDN tidak mencukupi. Harap Top Up.", false); return; }
                currentUserData.rdnBalance -= cost; currentUserData.lotOwned += lots; currentUserData.hasMadeFirstPurchase = true; updateUserData(); document.getElementById('orderModal').classList.add('hidden'); showNotification("Berhasil membeli " + formatNumber(lots) + " Lot GIAA. Saldo RDN terpotong " + formatRupiah(cost) + ".", true);
            }
        });

        safeAddEventListener('paymentConfirmBtn', 'click', () => {
            document.getElementById('paymentModal').classList.add('hidden');
            currentUserData.isTransactionPending = true; currentUserData.pendingTopUp = pendingTopUpAmount; 
            updateUserData();
            addDoc(collection(db, ADMIN_NOTIFS_COLLECTION), { type: 'TOPUP', user: currentUserId, name: currentUserData.name, amount: pendingTopUpAmount, timestamp: serverTimestamp() });
            showTransactionPopup("Top Up sedang diproses."); pendingTopUpAmount = 0;
        });
        safeAddEventListener('paymentCancelBtn', 'click', () => { document.getElementById('paymentModal').classList.add('hidden'); pendingTopUpAmount = 0; showNotification("Transaksi dibatalkan.", false); });
        safeAddEventListener('openCompanyInfoBtn', 'click', () => { document.getElementById('main-content').classList.add('hidden'); document.getElementById('company-info-page').classList.remove('hidden'); });
        safeAddEventListener('backToDashboardBtn', 'click', () => { document.getElementById('company-info-page').classList.add('hidden'); document.getElementById('main-content').classList.remove('hidden'); if(chartInstance) chartInstance.resize(); });

        const chatToggleBtn = document.getElementById('chat-toggle-btn');
        const appContainer = document.getElementById('app-container');
        if(chatToggleBtn) chatToggleBtn.addEventListener('click', () => {
             if (!currentUserId) return showNotification("Silakan Login terlebih dahulu untuk chat.", false);
             document.getElementById('chat-user-display').textContent = `${currentUserData.name} (${currentUserId})`;
             appContainer.classList.toggle('hidden');
             setupChatListener();
        });

        let chatIdentifier = null;
        function setupChatListener() {
            if (!currentUserId) return;
            chatIdentifier = `${currentUserData.name} (${currentUserId})`;
            onSnapshot(query(collection(db, CHAT_COLLECTION_PATH), orderBy('timestamp', 'asc')), (snapshot) => {
                const container = document.getElementById('messages-container'); container.innerHTML = ''; let foundMsg = false;
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    if (msg.senderEmail === chatIdentifier || msg.recipientEmail === chatIdentifier) {
                        foundMsg = true; const isMe = msg.senderEmail === chatIdentifier;
                        let bubble = `<div class="flex flex-col w-full ${isMe ? 'items-end' : 'items-start'}"><span class="text-[10px] text-gray-500 mb-1">${isMe ? 'Anda' : 'CS Admin'}</span><div class="max-w-[80%] px-3 py-2 shadow-md ${isMe ? 'bg-blue-600 text-white my-message' : 'bg-gray-100 text-gray-800 other-message'}"><p class="text-xs">${msg.text}</p></div></div>`;
                        container.insertAdjacentHTML('beforeend', bubble);
                    }
                });
                if(!foundMsg) container.innerHTML = '<div class="text-center text-xs text-gray-400 mt-4">Mulai percakapan dengan CS...</div>';
                container.scrollTop = container.scrollHeight;
            });
        }

        safeAddEventListener('send-button', 'click', sendChatMessage);
        const msgInput = document.getElementById('message-input');
        if(msgInput) msgInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendChatMessage(); });

        async function sendChatMessage() {
            const text = msgInput.value.trim(); if(!text || !currentUserId) return;
            await addDoc(collection(db, CHAT_COLLECTION_PATH), { senderId: currentUserId, senderEmail: chatIdentifier, text: text, isAdmin: false, timestamp: serverTimestamp() });
            msgInput.value = '';
        }

        const bidInput = document.getElementById('bidAmount');
        if(bidInput) bidInput.addEventListener('input', () => { document.getElementById('potentialProfit').textContent = formatRupiah(parseInt(bidInput.value||0)*0.8); });
        safeAddEventListener('btnCall', 'click', () => startTrade('UP'));
        safeAddEventListener('btnPut', 'click', () => startTrade('DOWN'));

        async function startTrade(direction) {
            if (!currentUserId) return showNotification("Silakan Login terlebih dahulu!", false);
            if (tradingState.isTrading) return;
            const bid = parseInt(bidInput.value);
            if (isNaN(bid) || bid < 10000) return showNotification("Minimal bid Rp 10.000", false);
            if (bid > currentUserData.rdnBalance) return showNotification("Saldo RDN tidak mencukupi!", false);
            let outcome = 'RANDOM';
            try { const cR = doc(db, "artifacts", appId, "public", "data", "ginvest_market", "config"); const s = await getDoc(cR); if(s.exists()) { const q = s.data().outcomeQueue || []; if (q.length > 0) { outcome = q[0]; updateDoc(cR, { outcomeQueue: q.slice(1) }); } } } catch(e) {}
            currentUserData.rdnBalance -= bid; updateUserData(); updateUI();
            tradingState = { isTrading: true, timer: 20, direction: direction, bidAmount: bid, entryPrice: currentPrice, targetOutcome: outcome };
            document.getElementById('activeTradeInfo').classList.remove('hidden');
            document.getElementById('tradePosition').innerHTML = direction === 'UP' ? '<span class="text-green-600">NAIK</span>' : '<span class="text-red-600">TURUN</span>';
            document.getElementById('tradeEntryPrice').textContent = tradingState.entryPrice;
            const timerDisplay = document.getElementById('tradeTimerDisplay');
            timerDisplay.classList.add('text-blue-600', 'animate-pulse');
            tradingState.interval = setInterval(() => {
                tradingState.timer--; timerDisplay.textContent = `00:${tradingState.timer < 10 ? '0' : ''}${tradingState.timer}`;
                if (tradingState.timer <= 0) finishTrade();
            }, 1000);
        }

        function finishTrade() {
            clearInterval(tradingState.interval); tradingState.isTrading = false;
            const finalPrice = currentPrice;
            const isWin = (tradingState.direction === 'UP' && finalPrice > tradingState.entryPrice) || (tradingState.direction === 'DOWN' && finalPrice < tradingState.entryPrice);
            const profit = tradingState.bidAmount * 0.8; const totalReturn = tradingState.bidAmount + profit;
            if (isWin) {
                currentUserData.rdnBalance += totalReturn; updateUserData();
                document.getElementById('resultIcon').innerHTML = ''; document.getElementById('resultTitle').textContent = "PROFIT!";
                document.getElementById('resultMessage').innerHTML = `Selamat! + ${formatRupiah(totalReturn)}`;
                addDoc(collection(db, ADMIN_NOTIFS_COLLECTION), { type: 'TRADE_WIN', user: currentUserId, name: currentUserData.name, amount: totalReturn, timestamp: serverTimestamp() });
            } else {
                document.getElementById('resultIcon').innerHTML = ''; document.getElementById('resultTitle').textContent = "LOSS";
                document.getElementById('resultMessage').innerHTML = `Maaf, prediksi salah.`;
                addDoc(collection(db, ADMIN_NOTIFS_COLLECTION), { type: 'TRADE_LOSS', user: currentUserId, name: currentUserData.name, amount: tradingState.bidAmount, timestamp: serverTimestamp() });
            }
            updateUI();
            document.getElementById('activeTradeInfo').classList.add('hidden');
            document.getElementById('tradeTimerDisplay').textContent = "00:20";
            document.getElementById('resultModal').classList.remove('hidden');
        }

        window.onload = async () => { await initAuth(); await seedDefaultUser(); };
    </script>
</body>
</html>
