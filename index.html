<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G Customer Service Chat</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts: Inter for high readability -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons for aesthetic appeal -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* --- TEMA: SIMPLE, FRIENDLY & ESTETIK (Soft Blue & Clean) --- */
        :root {
            --primary-color: #4299E1; /* Soft Blue */
            --accent-color: #4CAF50;  /* Hijau Aksen */
            --text-color: #374151;    /* Teks Dark Gray */
            --bg-color: #F7F9FC;      /* Latar Belakang Sangat Cerah */
            --card-bg: #FFFFFF;       /* Kartu Putih Bersih */
            --app-height: 100vh;
        }

        :root, body {
            font-family: 'Inter', sans-serif; 
            font-size: 16px; 
            color: var(--text-color);
        }
        
        body {
            background-color: var(--bg-color); 
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: var(--app-height); 
            min-height: var(--app-height);
            width: 100vw;
            overflow: hidden; 
        }

        .chat-container {
            background-color: var(--card-bg); 
            width: 100vw; 
            max-width: 450px; 
            height: var(--app-height); 
            max-height: 750px; 
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); /* Shadow lebih menonjol */
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease-in-out;
        }
        
        /* Scrollbar styling for a cleaner look */
        .chat-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .chat-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .chat-scrollbar::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 3px;
            opacity: 0.5;
        }
        
        /* Input & Button Styling */
        .input-chat {
            border: 1px solid #D1D5DB; /* Border lebih soft */
            border-radius: 9999px; /* Full rounded (pill shape) */
            padding: 10px 20px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-chat:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.3);
        }

        .chat-button {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border-radius: 9999px; /* Full rounded (pill shape) */
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(66, 153, 225, 0.4);
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
        }
        .chat-button:hover {
            background-color: #3182CE; /* Darker blue on hover */
            box-shadow: 0 6px 8px rgba(66, 153, 225, 0.5);
        }
        .chat-button:active {
            transform: scale(0.95);
        }

        /* Message Styling */
        .message-bubble {
            padding: 10px 16px;
            border-radius: 18px; /* Lebih rounded */
            word-wrap: break-word;
            max-width: 85%;
            font-size: 0.95rem;
            line-height: 1.4;
            margin-bottom: 2px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08); /* Shadow halus */
        }

        .message-self {
            background-color: var(--primary-color);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 6px;
        }

        .message-other {
            background-color: #E5E7EB; /* Light grey for others */
            color: var(--text-color);
            align-self: flex-start;
            border-bottom-left-radius: 6px;
        }
        
        /* Message Name Styling Fix */
        .sender-name-other {
            font-weight: 600;
            font-size: 0.75rem; /* Text lebih kecil */
            line-height: 1;
            margin-bottom: 2px;
            opacity: 0.85;
        }
        
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#4299E1',
                        'accent-green': '#4CAF50',
                        'soft-bg': '#F7F9FC',
                    }
                }
            }
        }
    </script>
</head>
<body>

    <div id="app" class="chat-container">
        <!-- Konten akan disuntikkan di sini oleh JavaScript -->
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, serverTimestamp, setLogLevel, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // =========================================================================
        // --- KONFIGURASI FIREBASE (DIAMBIL DARI KONTEKS SEBELUMNYA) ---
        // =========================================================================
        const MANUAL_CONFIG = {
            apiKey: "AIzaSyA_FynN_E6zxOEHo3k2t-olypo2Tu_D-zQ",
            authDomain: "webchatapp90.firebaseapp.com",
            projectId: "webchatapp90",
            storageBucket: "webchatapp90.firebasestorage.app",
            messagingSenderId: "199231928341",
            appId: "1:199231928341:web:cb1d7e99d65c3e2d06361c",
        };

        // --- Variabel Global Lingkungan ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : MANUAL_CONFIG.projectId || 'default-g-service';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : MANUAL_CONFIG;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let unsubscribe = null; 
        
        // --- KONSTANTA BARU: RUANGAN PUBLIK TUNGGAL ---
        const PUBLIC_ROOM_ID = 'g_service_chat_main_public'; 
        const MESSAGES_COLLECTION_NAME = 'messages';
        const ROOMS_COLLECTION_NAME = 'g_service_chat_rooms'; 
        const BOT_NAME = 'G-Service Assistant'; 
        
        // --- Pemetaan Warna Anonim untuk Membedakan Pengirim ---
        const USER_COLORS = [
            '#FF6347', '#4682B4', '#3CB371', '#FFA500', 
            '#9370DB', '#FF69B4', '#1E90FF', '#DAA520'
        ];
        let userColorMap = {};

        const getUserColor = (id) => {
            if (userColorMap[id]) {
                return userColorMap[id];
            }
            // Algoritma hashing sederhana untuk konsistensi warna
            const hash = id.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const colorIndex = hash % USER_COLORS.length;
            const color = USER_COLORS[colorIndex];
            userColorMap[id] = color;
            return color;
        };


        // --- App State ---
        let state = {
            currentView: 'loading', 
            username: 'Customer-ID', 
            roomId: PUBLIC_ROOM_ID, 
            chatMessages: [],
            isFirebaseReady: false, 
            loading: true,
            error: null,
            isLoggingOut: false 
        };
        
        // --- Utility Functions ---
        
        /** Mengatur tinggi viewport yang benar untuk mobile. */
        const setAppHeight = () => {
            const doc = document.documentElement;
            const newHeight = `${window.innerHeight}px`;
            doc.style.setProperty('--app-height', newHeight);
        };

        /** Logs an error message to the console and updates app state. */
        const logError = (msg, err = null) => {
            console.error(`[G-CHAT ERROR] ${msg}`, err);
             const uiMsg = `ERROR: ${msg}`;
             setNotification(uiMsg, 7000); 
             if (err) console.error(err);
             return false; 
        }

        /** Simple function to update state and re-render */
        const updateState = (newState) => {
            state = { ...state, ...newState };
            render();
        }
        
        /** Displays a temporary status message (not a critical error) on the UI. */
        const setNotification = (msg, duration = 5000) => {
            console.log(`[G-CHAT STATUS] ${msg}`); 
            updateState({ error: msg }); 

            setTimeout(() => {
                if (state.error === msg) {
                    updateState({ error: null });
                }
            }, duration);
        }

        /** Exponential backoff for Firebase API calls */
        const withRetry = async (fn, maxRetries = 5, delay = 1000) => {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    console.warn(`Attempt ${i + 1} failed. Retrying in ${delay / 1000}s...`, error);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        };

        // --- Firebase Setup (Otentikasi Anonim Otomatis) ---

        const setupFirebase = async () => {
            
            if (!firebaseConfig || !firebaseConfig.projectId) {
                return logError("Koneksi Gagal: Konfigurasi Firebase tidak ditemukan.");
            }
            
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                // setLogLevel('debug'); 
            } catch (initError) {
                return logError("Koneksi Gagal: Gagal inisialisasi layanan Firebase.", initError);
            }

            const authPromise = new Promise(resolve => {
                const unsubscribeAuth = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        unsubscribeAuth(); 
                        resolve(true);
                    } else {
                        try {
                            if (initialAuthToken) {
                                await withRetry(() => signInWithCustomToken(auth, initialAuthToken));
                            } else {
                                await withRetry(() => signInAnonymously(auth));
                            }
                        } catch (error) {
                            console.error("Authentication Attempt Failed:", error);
                            userId = null;
                            unsubscribeAuth();
                            resolve(false); 
                        }
                    }
                });
            });

            const authSuccess = await authPromise;
            
            if (!authSuccess || !userId) {
                 updateState({ isFirebaseReady: false, loading: false });
                 return logError("Otentikasi Gagal: Tidak dapat memperoleh User ID.");
            }

            // --- PENTING: SETEL NAMA PENGGUNA (Customer-) ---
            const shortId = userId.substring(0, 4).toUpperCase();
            const customerUsername = `Customer-${shortId}`; 

            updateState({ 
                isFirebaseReady: true, 
                loading: false, 
                username: customerUsername,
                currentView: 'chat' 
            });
            
            startChatListener(PUBLIC_ROOM_ID);
            
            console.log(`[FIREBASE READY] User ID: ${userId}, Username: ${customerUsername}`);
            
            // Kirim pesan sambutan BOT (hanya jika pesan pertama)
            if (state.chatMessages.length === 0) {
                 // Memberi waktu 1 detik agar listener sempat menarik data jika ada
                 setTimeout(() => {
                    // Cek lagi setelah 1 detik
                    if (state.chatMessages.length === 0) {
                        sendBotMessage(`Halo! Selamat datang di Saluran Pelayanan Pelanggan. Ada yang bisa kami bantu, ${customerUsername}?`);
                    }
                 }, 1000);
            }
        };


        // --- Chat Logic ---

        const getMessagesRef = (roomId) => {
            if (!db) throw new Error("Firestore not initialized.");
            // Path: /artifacts/{appId}/public/data/g_service_chat_rooms/{roomId}/messages
            const roomDocPath = `/artifacts/${appId}/public/data/${ROOMS_COLLECTION_NAME}/${roomId}`;
            return collection(db, roomDocPath, MESSAGES_COLLECTION_NAME);
        };

        const sendMessage = async (messageText, messageType = 'chat') => {
            if (!state.isFirebaseReady || !db) return logError("Koneksi belum siap.");
            if (!messageText.trim()) return;

            const message = {
                sender: state.username,
                text: messageText,
                timestamp: serverTimestamp(),
                userId: userId, 
                messageType: messageType 
            };

            try {
                await withRetry(() => addDoc(getMessagesRef(state.roomId), message));
            } catch (error) {
                logError("Gagal mengirim pesan. Periksa koneksi atau aturan keamanan.", error);
            }
        };
        
        /** Fungsi untuk mengirim pesan dari Bot Sistem */
        const sendBotMessage = async (messageText) => {
            if (!state.isFirebaseReady || !db) return;

            const message = {
                sender: BOT_NAME, 
                text: messageText,
                timestamp: serverTimestamp(),
                userId: 'SYSTEM_BOT', 
                messageType: 'chat' 
            };

            try {
                await withRetry(() => addDoc(getMessagesRef(state.roomId), message));
            } catch (error) {
                 console.error("Gagal mengirim pesan bot:", error);
            }
        };


        /** Starts listening for new messages in the public room */
        const startChatListener = (roomId) => {
            if (!state.isFirebaseReady) return logError("Listener gagal: Koneksi belum siap.");
            
            if (unsubscribe) {
                unsubscribe();
            }

            const messagesRef = getMessagesRef(roomId);
            const q = query(messagesRef);

            unsubscribe = onSnapshot(q, (snapshot) => {
                const messages = [];
                snapshot.forEach((doc) => {
                    const data = { id: doc.id, ...doc.data() };
                    if (data.messageType === 'chat') { 
                        messages.push(data);
                    }
                });
                
                // Sort data in memory
                messages.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                
                updateState({ chatMessages: messages }); 
                
                setTimeout(scrollToBottom, 50);

            }, (error) => {
                logError("Gagal mendengarkan pesan real-time (onSnapshot).", error);
            });
        };
        
        // --- Scrolling Function ---
        const scrollToBottom = () => {
            const scrollContainer = document.getElementById('chat-log');
            if (scrollContainer) {
                 scrollContainer.scrollTop = scrollContainer.scrollHeight;
            }
        };

        
        // --- View Handlers ---
        
        const handleSendMessage = (event) => { // Menerima event untuk preventDefault
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text) return;
            
            // --- LOGIC KODE RAHASIA ---
            if (text === '%%admin%%') {
                input.value = '';
                
                const newAdminName = "Admin G Invest";

                if (state.username === newAdminName) {
                    setNotification("Anda sudah menjadi Admin G Invest.", 3000);
                    return;
                }

                const oldUsername = state.username;
                
                // 1. Update state (username)
                updateState({ username: newAdminName });
                
                // 2. Send system announcement ke semua user
                sendBotMessage(`[Pemberitahuan] Akun ${oldUsername} kini telah diidentifikasi sebagai **${newAdminName}**.`);
                
                // 3. Notifikasi pribadi
                setNotification(`Selamat! Nama Anda telah diperbarui menjadi ${newAdminName}.`, 5000);
                return; // Berhenti tanpa mengirim kode sebagai pesan chat
            }
            // --- AKHIR LOGIC KODE RAHASIA ---

            // Logic kirim pesan normal
            sendMessage(text, 'chat'); 
            input.value = ''; 
            input.focus(); 
        };
        
        const handleInputKeypress = (event) => {
             // Cek jika tombol yang ditekan adalah Enter
            if (event.key === 'Enter') {
                handleSendMessage(event); // Kirim event ke handleSendMessage
                event.preventDefault(); 
            }
        };


        /** Handler logout (menghentikan listener dan kembali ke loading/auth) */
        const handleLogout = () => {
            if (unsubscribe) unsubscribe();
            // Kami tidak melakukan sign out permanen
            updateState({ 
                currentView: 'loading', 
                chatMessages: [], 
                isFirebaseReady: false, 
                loading: true,
                error: null
            });
            // Memulai ulang proses otentikasi untuk mendapatkan sesi anonim baru
            setupFirebase(); 
            setNotification("Memutus koneksi... menyambung kembali sebagai sesi baru.", 3000);
        };

        // --- Rendering Logic (HTML Templates) ---

        const renderLoadingView = () => `
            <div class="flex flex-col h-full items-center justify-center p-8 text-center bg-white rounded-xl">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-primary-blue border-t-transparent mb-4"></div>
                <h2 class="text-xl font-semibold mb-2 text-primary-blue">Menghubungkan ke Saluran Publik...</h2>
                <p class="text-gray-500 text-sm">${state.error || 'Otentikasi sebagai Pelanggan sedang diproses...'}</p>
                <button class="mt-6 text-xs text-gray-500 hover:text-red-500 transition duration-150" onclick="handleLogout()">
                    [Mulai Sesi Pelanggan Baru]
                </button>
            </div>
        `;
        
        const renderChatView = () => {
            const messagesHtml = state.chatMessages
                .map(msg => {
                
                const senderId = msg.userId || crypto.randomUUID(); 
                const isCurrentUser = userId !== null && senderId === userId;
                const isBot = senderId === 'SYSTEM_BOT';
                
                let messageClass = isCurrentUser ? 'message-self' : 'message-other';
                let senderNameDisplay = msg.sender;
                let senderStyle = '';
                let nameHtml = ''; // HTML untuk menampilkan nama

                if (isBot) {
                    messageClass = 'message-other bg-soft-bg text-gray-800 border-l-4 border-accent-green shadow-none';
                    senderNameDisplay = `<i data-lucide="bot" class="w-4 h-4 inline-block align-text-bottom mr-1"></i> ${BOT_NAME}`;
                    senderStyle = 'font-bold text-accent-green';
                    nameHtml = `<div class="sender-name-other" style="color: var(--accent-color);">${senderNameDisplay}</div>`;
                } else if (!isCurrentUser) {
                    // Pengguna lain (Customer/Pelanggan/Admin Lain)
                    const colorHex = getUserColor(senderId); 
                    senderNameDisplay = msg.sender;
                    // Terapkan warna unik ke nama pengirim lain
                    
                    // Jika pengirim lain adalah Admin, gunakan warna yang berbeda
                    const isOtherAdmin = senderNameDisplay.startsWith('Admin G Invest');
                    const adminColor = isOtherAdmin ? '#8B0000' : colorHex; // Dark Red untuk Admin lain
                    const adminIcon = isOtherAdmin ? '<i data-lucide="shield-check" class="w-3 h-3 inline-block align-text-top mr-0.5"></i>' : '';

                    nameHtml = `<div class="sender-name-other" style="color: ${adminColor};">${adminIcon} ${senderNameDisplay}</div>`;
                } else {
                    // Pengguna saat ini (diri sendiri, mungkin Admin)
                    const isSelfAdmin = state.username.startsWith('Admin G Invest');
                    const selfColor = isSelfAdmin ? 'text-red-600' : 'text-gray-400';
                    const selfIcon = isSelfAdmin ? '<i data-lucide="shield-check" class="w-3 h-3 inline-block align-text-top mr-0.5"></i>' : '';
                    
                    senderNameDisplay = `Anda (${state.username})`;
                    // Nama untuk diri sendiri diletakkan di atas bubble
                    nameHtml = `<div class="text-xs ${selfColor} mb-1 px-1 font-medium">${selfIcon} ${state.username}</div>`;
                }

                const timeStamp = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '??:??';
                
                // Tambahkan Timestamp di bawah bubble pesan
                const timeStampHtml = `<span class="text-xs text-gray-400 mt-0.5 px-1">${timeStamp}</span>`;


                return `
                    <div class="flex ${isCurrentUser ? 'justify-end' : 'justify-start'} w-full">
                        <div class="flex flex-col ${isCurrentUser ? 'items-end' : 'items-start'}">
                            <!-- Nama Pengirim (di atas bubble, kecuali jika BOT) -->
                            ${nameHtml} 
                            
                            <div class="message-bubble ${messageClass}">
                                ${msg.text}
                            </div>
                            
                            <!-- Timestamp -->
                            ${timeStampHtml}
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="flex flex-col h-full w-full">
                    
                    <!-- 1. HEADER (FIXED) - Lebih estetik -->
                    <div class="bg-primary-blue p-4 text-white flex-shrink-0 shadow-xl flex items-center justify-between">
                        <i data-lucide="handshake" class="w-6 h-6 mr-3"></i>
                        <h1 class="text-xl font-bold flex-grow text-center">G Customer Service Chat</h1>
                        <i data-lucide="user-check" class="w-5 h-5 ml-3 opacity-70"></i>
                    </div>

                    <div class="p-2 border-b border-gray-100 bg-gray-50 text-xs text-center text-gray-600 flex-shrink-0">
                        Anda terhubung sebagai <span class="font-semibold ${state.username.startsWith('Admin') ? 'text-red-600' : 'text-primary-blue'}">${state.username}</span> di Saluran Publik.
                    </div>

                    <!-- Notifikasi Error/Status (Jika ada) -->
                    ${state.error ? `<div class="bg-red-100 p-2 text-red-700 text-sm text-center flex-shrink-0 font-medium">${state.error}</div>` : ''}

                    <!-- 2. CHAT LOG (SCROLLABLE) -->
                    <div id="chat-log" class="flex-grow overflow-y-auto p-4 space-y-4 chat-scrollbar bg-soft-bg"> 
                        ${messagesHtml.length > 0 ? messagesHtml : '<div class="text-gray-500 text-center mt-12 text-base">Selamat datang! Kirim pesan pertama Anda.</div>'}
                    </div>

                    <!-- 3. FOOTER (INPUT & LOGOUT - FIXED) -->
                    <div class="p-4 flex-shrink-0 border-t border-gray-200 bg-card-bg">
                        <div class="flex space-x-2 items-center">
                            <input type="text" id="message-input" class="input-chat flex-grow" placeholder="Ketik pesan Anda..." onkeypress="handleInputKeypress(event)">
                            <button class="chat-button flex-shrink-0" onclick="handleSendMessage()">
                                <i data-lucide="send" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <button class="mt-3 text-xs text-gray-400 hover:text-red-500 w-full text-center transition duration-150" onclick="handleLogout()">
                            Putus Koneksi / Dapatkan Sesi Pelanggan Baru
                        </button>
                    </div>
                </div>
            `;
        };

        // --- Main Render Function ---
        
        // Expose global functions for HTML interaction
        window.handleSendMessage = handleSendMessage;
        window.handleLogout = handleLogout; 
        window.handleInputKeypress = handleInputKeypress; 
        
        const render = () => {
            const appDiv = document.getElementById('app');
            let content = '';

            switch (state.currentView) {
                case 'chat':
                    content = renderChatView();
                    // Render lucide icons after content is injected
                    setTimeout(() => {
                        lucide.createIcons();
                        scrollToBottom();
                        const input = document.getElementById('message-input');
                        if (input) {
                            input.focus();
                        }
                    }, 0); 
                    break;
                case 'loading':
                default:
                    content = renderLoadingView();
                    break;
            }

            appDiv.innerHTML = content;
        };


        // Initialize on load
        window.addEventListener('resize', setAppHeight);
        window.addEventListener('load', () => {
            setAppHeight(); 
            setupFirebase(); 
        });
        setAppHeight(); 
        render();

    </script>
</body>
</html>
